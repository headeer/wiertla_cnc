{% comment %}
  Wiertla Categories Component
  A component to display product categories and search functionality for the Wiertla CNC Shopify theme.
{% endcomment %}

{% assign section_id = section.id %}
{% assign items_per_page = section.settings.items_per_page | default: 20 %}

{% if section.settings.selected_collection != blank %}
  {% assign selected_collection = collections[section.settings.selected_collection] %}
{% else %}
  {% assign selected_collection = collections.all %}
{% endif %}

{% paginate selected_collection.products by 2000 %}
<div class="wiertla-categories">
  <div class="wiertla-categories__container">
    <!-- New Category Tabs -->
    <div class="wiertla-categories__tabs">
      <button class="wiertla-categories__tab active">PŁYTKI DO WIERTEŁ</button>
      <button class="wiertla-categories__tab">KORONKI DO WIERTEŁ</button>
      <button class="wiertla-categories__tab">REGENERACJA KORONEK KSEM</button>
    </div>
    
    <!-- New Status Filters -->
    <div class="wiertla-categories__status-filters">
      <button class="wiertla-categories__status-filter active">Nowe</button>
      <button class="wiertla-categories__status-filter">Używane</button>
    </div>
    
    <!-- New Category Icons -->
    <div class="wiertla-categories__icons">
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_koronkowe.svg' | asset_url }}" alt="Koronkowe" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">KORONKOWE</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_plytkowe.svg' | asset_url }}" alt="Płytkowe" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">PŁYTKOWE</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_vhm.svg' | asset_url }}" alt="VH" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">VHM</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_sandvik.svg' | asset_url }}" alt="Sandvik 880" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">SANDVIK 880</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_amec.svg' | asset_url }}" alt="AMEC" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">AMEC</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_ksem.svg' | asset_url }}" alt="KSEM" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">KSEM</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img src="{{ 'ico_big_all.svg' | asset_url }}" alt="Wszystkie" class="wiertla-categories__icon">
        <span class="wiertla-categories__icon-label">WSZYSTKIE</span>
      </div>
    </div>
  <div class="wiertla-categories__filters">
          <div class="wiertla-categories__filters-left">
            <button class="wiertla-categories__filter-button active" data-filter="wszystkie">Wszystkie</button>
            <select class="wiertla-categories__filter" data-filter="type">
              <option value="">Typ wiertła</option>
              <option value="VW">Koronkowe (VW)</option>
              <option value="PR">Płytkowe (PR)</option>
              <option value="WW">VHM (WW)</option>
              <option value="PS">Sandvik 880 (PS)</option>
              <option value="WK">KSEM (WK)</option>
              <option value="WV">AMEC (WV)</option>
            </select>
            <select class="wiertla-categories__filter" data-filter="crown">
              <option value="">Wykaz koronek</option>
              <option value="KK">KK</option>
              <option value="KI">KI</option>
              <option value="KS">KS</option>
              <option value="KT">KT</option>
              <option value="KA">KA</option>
            </select>
            <select class="wiertla-categories__filter" data-filter="manufacturer">
              <option value="">Producent</option>
              <option value="Sandvik">Sandvik</option>
              <option value="AMEC">AMEC</option>
              <option value="KSEM">KSEM</option>
            </select>
          </div>

          <div class="wiertla-categories__filters-right">
            <span class="wiertla-categories__per-page-label">Pokaż</span>
            <div class="wiertla-categories__per-page-buttons">
              <button class="wiertla-categories__per-page-button active" data-value="20">20</button>
              <button class="wiertla-categories__per-page-button" data-value="50">50</button>
              <button class="wiertla-categories__per-page-button" data-value="100">100</button>
            </div>
            <span class="wiertla-categories__per-page-label">/ na stronę</span>
          </div>
        </div>
    <div class="wiertla-categories__content">
      <!-- Left Column -->
      <div class="wiertla-categories__left-column">
        <div class="wiertla-search__container-top">
          <div class="wiertla-search__input-group">
            <input type="text" class="wiertla-search__input" placeholder="Wpisz szukaną frazę (fi / nazwa / symbol / producent)">
            <div class="wiertla-search__icon-wrapper">
              <img src="{{ 'Ico_search1.svg' | asset_url }}" alt="Search" class="wiertla-search__icon">
            </div>
          </div>
        </div>

        <!-- Preview Component -->
        <div class="wiertla-categories__preview">
          <h5 class="wiertla-categories__preview-title">zobacz obraz poglądowy</h5>
          <div class="wiertla-categories__preview-image">
            <img src="{{ 'table_koronkowe.png' | asset_url }}" alt="Preview" id="preview-image" class="wiertla-categories__preview-img" />
            <img src="{{ 'table_vhm.png' | asset_url }}" alt="Preview" id="preview-image" class="wiertla-categories__preview-img" />
            <img src="{{ 'table_ksem.png' | asset_url }}" alt="Preview" id="preview-image" class="wiertla-categories__preview-img" />
            <img src="{{ 'table_plytkowe.png' | asset_url }}" alt="Preview" id="preview-image" class="wiertla-categories__preview-img" />
            <img src="{{ 'table_amec.png' | asset_url }}" alt="Preview" id="preview-image" class="wiertla-categories__preview-img" />
            <img src="{{ 'table_sandavik.png' | asset_url }}" alt="Preview" id="preview-image" class="wiertla-categories__preview-img" />
          </div>
          <p class="wiertla-categories__preview-text">
            Najedź kursorem na wiertło w tabeli,<br>
            aby wyświetlić tu powiększony podgląd
          </p>
        </div>
      </div>

      <!-- Right Column -->
      <div class="wiertla-categories__right-column">
        <!-- Filters -->
      

        <!-- Table Component -->
        <div class="wiertla-categories__table-container">
          <table class="wiertla-categories__table">
            <thead>
              <tr>
                <th>Typ</th>
                <th>⌀ Fi</th>
                <th>D/mm</th>
                <th>Symbol</th>
                <th>Producent</th>
                <th>Cena netto</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- Products will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Results Count and Pagination -->
        <div class="wiertla-categories__results">
          <div class="wiertla-categories__results-wrapper">
            <div class="wiertla-categories__results-count">
              <span class="wiertla-categories__results-text">Wyświetlono wyniki </span>
              <span class="wiertla-categories__results-numbers" id="resultsCount"></span>
            </div>
            <div class="wiertla-categories__simple-pagination">
              <button class="wiertla-categories__pagination-button" id="prevPage" disabled>
                pokaż poprzednie
              </button>
              <button class="wiertla-categories__pagination-button" id="nextPage">
                pokaż następne
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Store all products data
  const allProducts = [
    {% for product in selected_collection.products %}
      {
        id: {{ product.id | json }},
        title: {{ product.title | json }},
        url: {{ product.url | json }},
        type: {{ product.type | json }},
        vendor: {{ product.vendor | json }},
        price: {{ product.price | money_without_trailing_zeros | json }},
        available: {{ product.available | json }},
        diameter: {{ product.metafields.custom.diameter.value | json }},
        length: {{ product.metafields.custom.length.value | json }},
        symbol: {{ product.metafields.custom.symbol.value | json }},
        rentable: {{ product.metafields.custom.rentable.value | json }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  // Log debug info
  console.log('Collection info:', {
    size: {{ selected_collection.products_count | json }},
    loadedProducts: allProducts.length
  });

  // Pagination state
  let currentPage = 1;
  let itemsPerPage = {{ items_per_page }};
  let totalPages = Math.ceil(allProducts.length / itemsPerPage);

  // DOM elements
  const tableBody = document.getElementById('productsTableBody');
  const prevButton = document.getElementById('prevPage');
  const nextButton = document.getElementById('nextPage');
  const resultsCount = document.getElementById('resultsCount');
  const perPageButtons = document.querySelectorAll('.wiertla-categories__per-page-button');

  // Function to update pagination state
  function updatePaginationState(newItemsPerPage) {
    itemsPerPage = parseInt(newItemsPerPage);
    totalPages = Math.ceil(allProducts.length / itemsPerPage);
    currentPage = 1; // Reset to first page when changing items per page
    renderProducts();
  }

  // Function to render products for current page
  function renderProducts(productsToRender = allProducts) {
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageProducts = productsToRender.slice(start, end);
    
    // Clear current table content
    tableBody.innerHTML = '';
    
    if (pageProducts.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 30px;">Brak produktów do wyświetlenia</td>
        </tr>
      `;
      resultsCount.textContent = `0 - 0 z ${productsToRender.length}`;
      return;
    }

    // Render products
    pageProducts.forEach(product => {
      if (product.available) {
        const row = document.createElement('tr');
        row.className = 'wiertla-categories__table-row';
        row.setAttribute('data-product-id', product.id);
        row.onclick = () => window.location.href = product.url;
        
        row.innerHTML = `
          <td>${product.type || ''}</td>
          <td>${product.diameter || ''}</td>
          <td>${product.length || ''}</td>
          <td>${product.symbol || ''}</td>
          <td>${product.vendor}</td>
          <td>${product.price}</td>
          <td>
            ${product.rentable ? '<span class="wiertla-categories__rent-icon">R</span>' : ''}
            <img src="{{ 'table_arrow.svg' | asset_url }}" alt="Arrow" class="wiertla-categories__table-arrow">
          </td>
        `;
        
        tableBody.appendChild(row);
      }
    });

    // Update results count
    resultsCount.textContent = `${start + 1} - ${Math.min(end, productsToRender.length)} z ${productsToRender.length}`;
    
    // Update pagination buttons
    prevButton.disabled = currentPage === 1;
    nextButton.disabled = currentPage === totalPages;
  }

  // Event listeners for pagination
  prevButton.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderProducts();
    }
  });

  nextButton.addEventListener('click', () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderProducts();
    }
  });

  // Handle per page selection
  perPageButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const newItemsPerPage = this.getAttribute('data-value');
      
      // Update active state
      perPageButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      // Update pagination and render
      updatePaginationState(newItemsPerPage);
    });
  });

  // Initialize table with default items per page
  renderProducts();

  // Search functionality
  const searchInput = document.querySelector('.wiertla-search__input');

  function performSearch(searchTerm) {
    const filteredProducts = allProducts.filter(product => {
      const searchString = searchTerm.toLowerCase();
      return (
        (product.title && product.title.toLowerCase().includes(searchString)) ||
        (product.type && product.type.toLowerCase().includes(searchString)) ||
        (product.vendor && product.vendor.toLowerCase().includes(searchString)) ||
        (product.symbol && product.symbol.toLowerCase().includes(searchString))
      );
    });

    currentPage = 1;
    totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    renderProducts(filteredProducts);
  }

  searchInput.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      performSearch(searchInput.value.trim());
    }
  });

  // Handle filters
  const filters = document.querySelectorAll('.wiertla-categories__filter');
  const filterButton = document.querySelector('.wiertla-categories__filter-button');

  function applyFilters() {
    let filteredProducts = [...allProducts];
    
    filters.forEach(filter => {
      const filterType = filter.getAttribute('data-filter');
      const filterValue = filter.value;
      
      if (filterValue) {
        filteredProducts = filteredProducts.filter(product => {
          switch(filterType) {
            case 'type':
              return product.type === filterValue;
            case 'manufacturer':
              return product.vendor === filterValue;
            // Add other filter cases as needed
            default:
              return true;
          }
        });
      }
    });

    currentPage = 1;
    totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    renderProducts(filteredProducts);
  }

  filters.forEach(filter => {
    filter.addEventListener('change', applyFilters);
  });

  filterButton.addEventListener('click', (e) => {
    e.preventDefault();
    filters.forEach(filter => filter.value = '');
    currentPage = 1;
    renderProducts();
  });
});
</script>

{% assign drill_stats_nav = sections['drill-stats-nav'] %}
{% render 'drill-stats-nav' %}

{% endpaginate %}

{% schema %}
{
  "name": "Wiertla Categories",
  "settings": [
    {
      "type": "collection",
      "id": "selected_collection",
      "label": "Select Collection to Display",
      "info": "Choose which collection's products to display in this section"
    },
    {
      "type": "range",
      "id": "items_per_page",
      "label": "Products per page",
      "default": 20,
      "min": 10,
      "max": 1000,
      "step": 10
    }
  ],
  "presets": [
    {
      "name": "Wiertla Categories",
      "category": "Custom Components"
    }
  ]
}
{% endschema %}

{% stylesheet %}
/* Original Styles */
.wiertla-categories {
  padding: 40px 0;
  font-family: 'Montserrat', sans-serif;
}

.wiertla-categories__container {
  max-width: 1420px;
  margin: 0 auto;
}

/* New Category Tabs Styles */
.wiertla-categories__tabs {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.wiertla-categories__tab {
  width: 234px;
  height: 50px;
  border: 3px solid #F5F5F8;
  padding: 0;
  font-family: "League Spartan";
  font-weight: 700;
  font-size: 18px;
  line-height: 16.6px;
  letter-spacing: 6%;
  text-transform: uppercase;
  background: none;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.wiertla-categories__tab.active {
  background: #F5F5F8;
}

/* New Status Filters Styles */
.wiertla-categories__status-filters {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
}

.wiertla-categories__status-filter {
  width: 139px;
  height: 42px;
  border: 2px solid #F5F5F8;
  border-radius: 30px;
  padding: 10px 22px;
  font-family: 'Montserrat';
  font-weight: 500;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: 3%;
  text-align: center;
  color: #112832;
  background: #FFFFFF;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: none;
}

.wiertla-categories__status-filter.active {
  background: #F5F5F8;
}

/* New Category Icons Styles */
.wiertla-categories__icons {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0;
  margin-bottom: 40px;
  position: relative;
}

.wiertla-categories__icon-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  position: relative;
}

.wiertla-categories__icon-item:not(:last-child)::after {
  content: '';
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 1px;
  height: 100%;
  background: #F5F5F8;
}

.wiertla-categories__icon {
  width: auto;
  height: auto;
  padding: 0 20px;
}

.wiertla-categories__icon-label {
  font-family: "League Spartan";
  font-weight: 700;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: 6%;
  text-transform: uppercase;
  text-decoration: underline;
  text-decoration-style: solid;
  white-space: nowrap;
}

/* Original Content Styles */
.wiertla-categories__content {
  display: flex;
  flex-direction: row;
  gap: 40px;
}

.wiertla-categories__left-column {
  width: 425px;
  flex-shrink: 0;
}

.wiertla-categories__right-column {
  flex: 1;
}

/* Search Styles */
.wiertla-search__container-top {
  margin-bottom: 20px;
  width: 100%;
}

.wiertla-search__input-group {
  position: relative;
  display: flex;
  align-items: center;
  width: 100%;
}

.wiertla-search__input {
  width: 100%;
  height: 40px;
  padding: 8px 40px 8px 12px;
  border: 2px solid #112832;
  border-radius: 4px;
  font-family: "Montserrat";
  font-size: 14px;
  line-height: 22px;
}

.wiertla-search__icon-wrapper {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.wiertla-search__icon {
  width: 20px;
  height: 20px;
  object-fit: contain;
}

.wiertla-search__button {
  font-family: "League Spartan";
  font-weight: 700;
  font-size: 18px;
  line-height: 16.6px;
  letter-spacing: 6%;
  text-transform: uppercase;
  display: inline-flex;
  align-items: center;
  gap: 22px;
  background: #FCD34D;
  border: 2px solid #112832;
  border-radius: 40px;
  padding: 8.5px 15px 8.5px 20px;
  cursor: pointer;
  transition: opacity 0.3s;
}

.wiertla-search__button:hover {
  opacity: 0.9;
}

/* Preview Component Styles */
.wiertla-categories__preview {
  width: 100%;
  padding: 20px;
  border: 2px dashed #E2E2E7;
}

.wiertla-categories__preview-title {
  font-family: 'League Spartan', sans-serif;
  font-weight: 700;
  font-size: 18px;
  line-height: 16.6px;
  letter-spacing: 0.96px;
  text-transform: uppercase;
  margin-bottom: 20px;
}

.wiertla-categories__preview-image {
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
}

.wiertla-categories__preview-img {
  max-width: 100%;
  height: auto;
}

.wiertla-categories__preview-text {
  font-weight: 500;
  font-size: 16px;
  line-height: 22px;
  letter-spacing: 0.48px;
  color: #445D68;
}

/* Filters Styles */
.wiertla-categories__filters {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 40px;
  background: white;
  padding: 20px;
  border-radius: 30px;
}

.wiertla-categories__filters-left {
  display: flex;
  gap: 10px;
}

.wiertla-categories__filter-button {
  height: 40px;
  padding: 0 15px;
  border-radius: 30px;
  font-family: 'Montserrat';
  font-weight: 500;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: 3%;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.wiertla-categories__filter-button.active {
  background: #F5F5F8;
}

.wiertla-categories__filter {
  height: 40px;
  padding: 0 15px;
  border: 2px solid #E2E2E7;
  border-radius: 30px;
  font-family: 'Montserrat', sans-serif;
  font-size: 14px;
  min-width: 150px;
  background: white;
}

.wiertla-categories__filters-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.wiertla-categories__per-page-label {
  font-size: 14px;
  color: #445D68;
}

.wiertla-categories__per-page-buttons {
  display: flex;
  gap: 5px;
}

.wiertla-categories__per-page-button {
  height: 40px;
  padding: 0 15px;
  border: 2px solid #E2E2E7;
  border-radius: 30px;
  background: white;
  font-family: 'Montserrat', sans-serif;
  font-size: 14px;
  cursor: pointer;
}

.wiertla-categories__per-page-button.active {
  background: var(--color-gray-50);
  border-color: var(--color-cyan-950);
}

/* Table Styles */
.wiertla-categories__table-container {
  background: white;
  padding: 20px;
  border-radius: 0 0 30px 30px;
  margin-top: 20px;
  max-height: 800px;
  overflow-y: auto;
}

.wiertla-categories__table {
  width: 100%;
  border-collapse: collapse;
}

.wiertla-categories__table th {
  padding: 16px;
  text-align: left;
  border-bottom: 1px solid var(--color-gray-200);
  font-family: 'League Spartan', sans-serif;
  font-weight: 700;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: 0.06em;
  color: #112832;
}

.wiertla-categories__table td {
  padding: 6.5px 17px;
  text-align: left;
  border-bottom: 1px solid var(--color-gray-200);
  font-family: 'Montserrat', sans-serif;
  font-weight: 500;
  font-size: 16px;
  line-height: 22px;
  letter-spacing: 0.03em;
  color: #112832;
  cursor: pointer;
}

.wiertla-categories__table-row:hover {
  background-color: #112832;
}

.wiertla-categories__table-row:hover td {
  color: #F5F5F8;
}

.wiertla-categories__table-row td:last-child {
  display: flex;
  align-items: center;
  gap: 10px;
}

.wiertla-categories__table-arrow {
  width: 24px;
  height: 24px;
}

/* Results Count Styles */
.wiertla-categories__results {
  margin-top: 20px;
  padding: 0 20px;
}

.wiertla-categories__results-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.wiertla-categories__results-count {
  display: flex;
  align-items: baseline;
  gap: 5px;
}

.wiertla-categories__results-text {
  font-family: 'Montserrat', sans-serif;
  font-weight: 400;
  font-size: 16px;
  line-height: 22px;
  letter-spacing: 0.03em;
  color: #112832;
}

.wiertla-categories__results-numbers {
  font-family: 'League Spartan', sans-serif;
  font-weight: 700;
  font-size: 18px;
  line-height: 100%;
  letter-spacing: 0.06em;
  color: #112832;
}

/* Pagination Button Styles */
.wiertla-categories__simple-pagination {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 40px;
}

.wiertla-categories__pagination-button {
  width: 207px;
  height: 50px;
  padding: 11px 22px;
  gap: 22px;
  border-radius: 40px;
  background: #112832;
  color: #F5F5F8;
  border: none;
  font-family: 'League Spartan', sans-serif;
  font-size: 16px;
  font-weight: 700;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.wiertla-categories__pagination-button:hover {
  opacity: 0.9;
}

.wiertla-categories__pagination-button.disabled {
  background: #E2E2E7;
  color: #445D68;
  cursor: not-allowed;
  opacity: 0.7;
}

.wiertla-categories__pagination-button.disabled:hover {
  opacity: 0.7;
}

@media (max-width: 1024px) {
  .wiertla-categories__container {
    padding: 0 32px;
  }
  
  .wiertla-categories__content {
    flex-direction: column;
  }
  
  .wiertla-categories__left-column {
    width: 100%;
  }
  
  .wiertla-categories__tabs {
    flex-direction: column;
  }
  
  .wiertla-categories__icons {
    flex-wrap: wrap;
    justify-content: center;
  }
}

@media (max-width: 768px) {
  .wiertla-categories__container {
    padding: 0 16px;
  }
  
  .wiertla-categories__filters {
    flex-direction: column;
    gap: 20px;
  }
  
  .wiertla-categories__filters-left {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .wiertla-categories__filters-right {
    flex-wrap: wrap;
    justify-content: center;
  }
}
{% endstylesheet %} 