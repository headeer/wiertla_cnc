{% comment %}
  Wiertla Categories Component - Modular Version
  A component to display product categories and search functionality for the Wiertla CNC Shopify theme.
  This version uses external JavaScript modules for better maintainability and smaller file size.
{% endcomment %}

{{ 'wiertla-filter-modal.css' | asset_url | stylesheet_tag }}
<script src="{{ 'wiertla-categories-filter.js' | asset_url }}" async></script>

{% comment %} Variables are handled by JavaScript modules {% endcomment %}

{% comment %} pagination removed: hydrating via JS {% endcomment %}
<div class="wiertla-categories__container">
  <div class="wiertla-categories__tabs desktop">
    <button class="wiertla-categories__tab active" data-tab-type="wiertla" data-translate="header.nav.drills">
      WIERTŁA
    </button>
    <button
      class="wiertla-categories__tab"
      data-translate="wiertla_categories.tabs.plates_for_drills"
      data-tab-type="plytki"
    >
      PŁYTKI DO WIERTEŁ
    </button>
    <button
      class="wiertla-categories__tab"
      data-translate="wiertla_categories.tabs.crowns_for_drills"
      data-tab-type="koronki"
    >
      KORONKI DO WIERTEŁ
    </button>
  </div>
</div>
<div class="wiertla-categories">
  <div class="wiertla-categories__container">
    <div class="wiertla-logos--mobile">
      {% render 'wiertla-categories-logos' %}
    </div>

    <div class="wiertla-categories__tabs mobile">
      <button class="wiertla-categories__tab active" data-tab-type="wiertla" data-translate="header.nav.drills">
        WIERTŁA
      </button>
      <button
        class="wiertla-categories__tab"
        data-translate="wiertla_categories.tabs.plates_short"
        data-tab-type="plytki"
      >
        PŁYTKI
      </button>
      <button
        class="wiertla-categories__tab"
        data-translate="wiertla_categories.tabs.crowns_short"
        data-tab-type="koronki"
      >
        KORONKI
      </button>
    </div>

    <div class="wiertla-categories__icons mobile">
      <div class="wiertla-categories__icon-item" data-category="wszystkie">
        <img
          src="{{ 'ico_big_all.svg' | asset_url }}"
          alt="Wszystkie"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.all">WSZYSTKIE</span>
      </div>

      <!-- Wiertła Categories (default) -->
      <div class="wiertla-categories__icon-item wiertla-tab-wiertla" data-category="koronkowe">
        <img
          src="{{ 'ico_big_koronkowe.svg' | asset_url }}"
          alt="Koronkowe"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.crown">KORONKOWE</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-wiertla" data-category="plytkowe">
        <img
          src="{{ 'ico_big_plytkowe.svg' | asset_url }}"
          alt="Płytkowe"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.plate">PŁYTKOWE</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-wiertla" data-category="vhm">
        <img
          src="{{ 'ico_big_vhm.svg' | asset_url }}"
          alt="VHM"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.vhm">VHM</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-wiertla" data-category="sandvik">
        <img
          src="{{ 'ico_big_sandvik.svg' | asset_url }}"
          alt="Sandvik 880"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.sandvik"
          >SANDVIK 880</span
        >
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-wiertla" data-category="amec">
        <img
          src="{{ 'ico_big_amec.svg' | asset_url }}"
          alt="AMEC"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.amec">AMEC</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-wiertla" data-category="ksem">
        <img
          src="{{ 'ico_big_ksem.svg' | asset_url }}"
          alt="KSEM"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label" data-translate="wiertla_categories.icons.ksem">KSEM</span>
      </div>

      <!-- Płytki Categories -->
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="wcmx" style="display: none;">
        <img
          src="{{ 'ico_wcmx.png' | asset_url }}"
          alt="WCMX"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">WCMX</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="lcmx" style="display: none;">
        <img
          src="{{ 'ico_lcmx-881.svg' | asset_url }}"
          alt="LCMX"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">LCMX,811</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="dft" style="display: none;">
        <img
          src="{{ 'ico_dft.svg' | asset_url }}"
          alt="DFT"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">DFT</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="880" style="display: none;">
        <img
          src="{{ 'ico_880.svg' | asset_url }}"
          alt="880"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">880</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="wogx" style="display: none;">
        <img
          src="{{ 'ico_wogx.svg' | asset_url }}"
          alt="WOGX"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">WOGX</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="spgx" style="display: none;">
        <img
          src="{{ 'ico_spgx.svg' | asset_url }}"
          alt="SPGX"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">SPGX</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-plytki" data-category="p284" style="display: none;">
        <img
          src="{{ 'ico_p284.svg' | asset_url }}"
          alt="P284"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">P284</span>
      </div>

      <!-- Koronki Categories -->
      <div
        class="wiertla-categories__icon-item wiertla-tab-koronki"
        data-category="ksem_koronki"
        style="display: none;"
      >
        <img
          src="{{ 'ico_ksem.svg' | asset_url }}"
          alt="KSEM"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">KSEM</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-koronki" data-category="idi" style="display: none;">
        <img
          src="{{ 'ico_idi.svg' | asset_url }}"
          alt="IDI"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">IDI</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-koronki" data-category="p600" style="display: none;">
        <img
          src="{{ 'ico_p600.svg' | asset_url }}"
          alt="P600"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">P600</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-koronki" data-category="icm" style="display: none;">
        <img
          src="{{ 'ico_icm.svg' | asset_url }}"
          alt="ICM"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">ICM</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-koronki" data-category="icp" style="display: none;">
        <img
          src="{{ 'ico_icp.svg' | asset_url }}"
          alt="ICP"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">ICP</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-koronki" data-category="870" style="display: none;">
        <img
          src="{{ 'ico_870.svg' | asset_url }}"
          alt="870"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">870</span>
      </div>
      <div
        class="wiertla-categories__icon-item wiertla-tab-koronki"
        data-category="amec_koronki"
        style="display: none;"
      >
        <img
          src="{{ 'ico_amec.svg' | asset_url }}"
          alt="AMEC"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">AMEC</span>
      </div>
      <div class="wiertla-categories__icon-item wiertla-tab-koronki" data-category="ktip" style="display: none;">
        <img
          src="{{ 'ico_ktip.svg' | asset_url }}"
          alt="KTIP"
          class="wiertla-categories__icon"
          width="24"
          height="24"
        >
        <span class="wiertla-categories__icon-label">KTIP</span>
      </div>
    </div>

    <!-- Mobile Header (Only visible on mobile) -->
    {% render 'wiertla-categories-mobile-header', section: section %}

    <!-- Desktop Header (Only visible on desktop) -->
    <div class="wiertla-categories__header desktop">
      <div class="wiertla-categories__filters">
        <!-- Filter button -->
        <div class="wiertla-categories__filters-button-wrapper mobile">
          <button class="wiertla-categories__filters-button">
            <span data-translate="wiertla_categories.filters.button">Filtry</span>
            <div class="wiertla-categories__filters-button-icon"></div>
          </button>
        </div>

        <!-- Include Category Filters Component -->
        {% render 'wiertla-categories-filters' %}
      </div>
    </div>

    <!-- Mobile Filter Modal (Hidden by default) -->
    {% render 'wiertla-categories-mobile' %}
  </div>
</div>
<div class="wiertla-categories bg_neutral">
  <div class="wiertla-categories__container">
    <!-- Table Content -->
    <div class="wiertla-categories__content wiertla-categories__layout">
      <!-- Left Column -->
      <div class="wiertla-categories__left-column">
        <!-- Include Search Component -->
        {% render 'wiertla-categories-search' %}

        <!-- Include Mobile Tabs (Only visible on mobile) -->
        {% render 'wiertla-categories-tabs-mobile' %}
      </div>

      <!-- Right Column -->
      <div class="wiertla-categories__right-column">
        <!-- Include Table Component -->
        {% render 'wiertla-categories-table' %}
      </div>
    </div>
  </div>
</div>
<!-- Include Fullscreen Component -->
{% render 'wiertla-categories-fullscreen' %}

<!-- Load modular JavaScript files in correct order -->
<script src="{{ 'wiertla-categories-utils.js' | asset_url }}?v=20250116-007"></script>
<script src="{{ 'wiertla-categories-core.js' | asset_url }}?v=20250116-007"></script>
<script src="{{ 'wiertla-categories-filtering.js' | asset_url }}?v=20250116-007"></script>
<script src="{{ 'wiertla-categories-table.js' | asset_url }}?v=20250116-007"></script>
<script src="{{ 'wiertla-categories-fullscreen.js' | asset_url }}?v=20250116-007"></script>

<!-- Product data hydration script -->
<script type="application/json" data-disabled="fullscreen-inline">
  // Handled in assets/theme.js
</script>

<!-- Initialize the modular system -->
<script>
  // Initialize the modular Wiertla CNC system
  document.addEventListener('DOMContentLoaded', async function() {
    // Wait for all modules to be loaded
    setTimeout(async function() {
      console.log('[Wiertla] Modular system initialized');
      
      // Check if all required functions are available
      if (window.applyFilters && window.generateTable && window.filterProducts && window.loadProducts) {
        console.log('[Wiertla] All modules loaded successfully');
        
        // Load products first
        try {
          const products = await window.loadProducts();
          if (products && products.length > 0) {
            console.log(`[Wiertla] Products loaded: ${products.length}`);
            // Update allProducts reference
            if (window.allProducts !== undefined) {
              window.allProducts = products;
            }
            // Apply filters to populate the table
            console.log('[Wiertla] Calling applyFilters to populate table...');
            try {
              window.applyFilters();
              console.log('[Wiertla] applyFilters completed successfully');
            } catch (error) {
              console.error('[Wiertla] Error in applyFilters:', error);
            }
            
            // Test: Try to call generateTable directly with all products
            console.log('[Wiertla] Testing direct generateTable call...');
            try {
              if (window.generateTable) {
                console.log('[Wiertla] Calling generateTable with all products...');
                window.generateTable(products);
                console.log('[Wiertla] generateTable call completed');
              } else {
                console.log('[Wiertla] generateTable function not found');
              }
            } catch (error) {
              console.error('[Wiertla] Error in generateTable:', error);
            }
            
            // Test: Check what filterProducts returns
            console.log('[Wiertla] Testing filterProducts...');
            try {
              if (window.filterProducts) {
                const filtered = window.filterProducts();
                console.log('[Wiertla] filterProducts returned:', filtered.length, 'products');
                if (filtered.length === 0) {
                  console.log('[Wiertla] No products after filtering - checking why...');
                  console.log('[Wiertla] Sample product for filtering check:', products[0]);
                }
              } else {
                console.log('[Wiertla] filterProducts function not found');
              }
            } catch (error) {
              console.error('[Wiertla] Error in filterProducts:', error);
            }
            
            // Test: Try to manually populate table with first few products
            console.log('[Wiertla] Testing manual table population...');
            const tableBody = document.querySelector('.wiertla-categories__table tbody');
            if (tableBody && products.length > 0) {
              console.log('[Wiertla] Table body found, adding test products...');
              tableBody.innerHTML = '';
              
              // Add first 5 products as a test
              const testProducts = products.slice(0, 5);
              console.log('[Wiertla] Sample product data:', testProducts[0]);
              testProducts.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                  <td class="wiertla-categories__table-cell">${product.custom_typ || product.typ || '-'}</td>
                  <td class="wiertla-categories__table-cell">${product.custom_fi || product.fi || '-'}</td>
                  <td class="wiertla-categories__table-cell">${product.custom_symbol || product.symbol || '-'}</td>
                  <td class="wiertla-categories__table-cell">${product.vendor || '-'}</td>
                  <td class="wiertla-categories__table-cell">${product.price || '-'}</td>
                  <td class="wiertla-categories__table-cell">${product.sku || '-'}</td>
                  <td class="wiertla-categories__table-cell">Test Product ${index + 1}</td>
                `;
                tableBody.appendChild(row);
              });
              console.log('[Wiertla] Added', testProducts.length, 'test products to table');
            } else {
              console.log('[Wiertla] Table body not found or no products');
            }
            
            console.log('[Wiertla] applyFilters called, checking table...');
          } else {
            console.error('[Wiertla] No products loaded');
          }
        } catch (error) {
          console.error('[Wiertla] Error loading products:', error);
        }
        
        // Listen for hydration completion to refresh table with all products
        window.addEventListener('wiertla:hydrateComplete', function(event) {
          console.log(`[Wiertla] Hydration complete! Total products: ${event.detail.total}`);
          if (window.applyFilters) {
            console.log('[Wiertla] Refreshing table with all products...');
            window.applyFilters();
          }
        });
      } else {
        console.error('[Wiertla] Missing required functions:', {
          applyFilters: !!window.applyFilters,
          generateTable: !!window.generateTable,
          filterProducts: !!window.filterProducts,
          loadProducts: !!window.loadProducts
        });
        
        // Try again after a longer delay
        setTimeout(async function() {
          if (window.applyFilters && window.generateTable && window.filterProducts && window.loadProducts) {
            console.log('[Wiertla] Retry successful - loading products and applying filters');
            try {
              const products = await window.loadProducts();
              if (products && products.length > 0) {
                if (window.allProducts !== undefined) {
                  window.allProducts = products;
                }
                window.applyFilters();
              }
            } catch (error) {
              console.error('[Wiertla] Error in retry:', error);
            }
          } else {
            console.error('[Wiertla] Modules still not loaded after retry');
          }
        }, 500);
      }
    }, 200);
  });
</script>

{% schema %}
{
  "name": "Wiertla Categories",
  "settings": [
    {
      "type": "collection",
      "id": "selected_collection",
      "label": "Selected Collection",
      "info": "Choose the collection to display products from"
    },
    {
      "type": "range",
      "id": "items_per_page",
      "label": "Items per page",
      "min": 50,
      "max": 500,
      "step": 50,
      "default": 100,
      "info": "Number of products to display per page"
    }
  ],
  "presets": [
    {
      "name": "Wiertla Categories"
    }
  ]
}
{% endschema %}
