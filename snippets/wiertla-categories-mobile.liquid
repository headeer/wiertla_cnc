{% comment %} 
  Wiertla Categories Mobile Components
  A reusable component to display the mobile components for the Wiertla CNC Shopify theme. 
{% endcomment %}

<!-- Mobile Category Navigation -->
<div class="wiertla-categories__mobile-nav">
  <div class="wiertla-categories__scroll-container">
    <div class="wiertla-categories__icons mobile">
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_koronkowe.svg' | asset_url }}"
          alt="Koronkowe"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">KORONKOWE</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_plytkowe.svg' | asset_url }}"
          alt="Płytkowe"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">PŁYTKOWE</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_vhm.svg' | asset_url }}"
          alt="VH"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">VHM</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_sandvik.svg' | asset_url }}"
          alt="Sandvik 880"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">SANDVIK 880</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_amec.svg' | asset_url }}"
          alt="AMEC"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">AMEC</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_ksem.svg' | asset_url }}"
          alt="KSEM"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">KSEM</span>
      </div>
      <div class="wiertla-categories__icon-item">
        <img
          src="{{ 'ico_big_all.svg' | asset_url }}"
          alt="Wszystkie"
          class="wiertla-categories__icon"
          width="24"
          height="24">
        <span class="wiertla-categories__icon-label">WSZYSTKIE</span>
      </div>
    </div>
  </div>
  <div class="wiertla-categories__scroll-indicator">
    <span class="wiertla-categories__scroll-dot active"></span>
    <span class="wiertla-categories__scroll-dot"></span>
    <span class="wiertla-categories__scroll-dot"></span>
  </div>
</div>


<!-- Mobile Filter Modal -->
<div class="wiertla-categories__mobile-filter-modal" style="display: none;">
  <div class="wiertla-categories__mobile-filter-wrapper">
    <!-- Filter header -->
    <div class="wiertla-categories__mobile-filter-header">
      <div class="wiertla-categories__mobile-filter-icon">
        <img
          src="{{ 'icon_filter.svg' | asset_url }}"
          alt="Filter"
          class="wiertla-categories__mobile-filter-icon-inner"
          width="24"
          height="24">
      </div>
      <div class="wiertla-categories__mobile-filter-title">filtruj wiertła w tabeli</div>
      <div class="wiertla-categories__mobile-filter-close-wrapper">
        <img
          src="{{ 'closee.svg' | asset_url }}"
          alt="Close"
          class="wiertla-categories__mobile-filter-close"
          width="24"
          height="24">
      </div>
    </div>

    <!-- Filter options -->
    <div class="wiertla-categories__mobile-filter-options">
      <!-- Typ wiertła filter (only for wiertla tab) -->
      <div class="wiertla-categories__mobile-filter-dropdown">
        <select class="wiertla-categories__mobile-filter-select wiertla-filter-type" data-filter="typ" data-tab="wiertla">
          <option value="">Typ wiertła</option>
          <option value="koronkowe">Koronkowe</option>
          <option value="plytkowe">Płytkowe</option>
          <option value="vhm">VHM</option>
          <option value="sandvik">Sandvik 880</option>
          <option value="ksem">KSEM</option>
          <option value="amec">AMEC</option>
        </select>
      </div>
      
      <!-- Rodzaj filter for plytki tab -->
      <div class="wiertla-categories__mobile-filter-dropdown">
        <select class="wiertla-categories__mobile-filter-select wiertla-filter-rodzaj" data-filter="rodzaj" data-tab="plytki" style="display:none;">
          <option value="">Rodzaj</option>
          <option value="wcmx">WCMX</option>
          <option value="lcmx">LCMX</option>
          <option value="811">811</option>
          <option value="dft">DFT</option>
          <option value="880">880</option>
          <option value="wogx">WOGX</option>
          <option value="spgx">SPGX</option>
          <option value="p284">P284</option>
        </select>
      </div>
      
      <!-- Rodzaj filter for koronki tab -->
      <div class="wiertla-categories__mobile-filter-dropdown">
        <select class="wiertla-categories__mobile-filter-select wiertla-filter-rodzaj" data-filter="rodzaj" data-tab="koronki" style="display:none;">
          <option value="">Rodzaj</option>
          <option value="ksem">KSEM</option>
          <option value="idi">IDI</option>
          <option value="p600">P600</option>
          <option value="icm">ICM</option>
          <option value="icp">ICP</option>
          <option value="870">870</option>
          <option value="amec">AMEC</option>
          <option value="ktip">ktip</option>
        </select>
      </div>
      
      <div class="wiertla-categories__mobile-filter-dropdown">
        <select class="wiertla-categories__mobile-filter-select" data-filter="manufacturer">
          <option value="">Producent</option>
          <option value="Sandvik">SANDVIK</option>
          <option value="Walter">WALTER</option>
          <option value="ISCAR">ISCAR</option>
          <option value="KENNAMETAL">KENNAMETAL</option>
          <option value="DSK">DSK</option>
          <option value="AMEC">AMEC</option>
        </select>
      </div>
    </div>

    <!-- Show all button -->
    <div class="wiertla-categories__mobile-filter-show-all">
      <button class="wiertla-categories__mobile-show-all-button" onclick="clearAllFilters()">
        <span>Pokaż wszystkie</span>
      </button>
    </div>

    <!-- Filter button -->
    <div class="wiertla-categories__mobile-filter-button-wrapper">
      <button class="wiertla-categories__mobile-filter-sort-button" onclick="applyMobileSort()">
        <span>Sortuj wiertła</span>
        <img
          src="{{ 'icon_filter.svg' | asset_url }}"
          alt="Sort"
          class="wiertla-categories__mobile-filter-sort-icon"
          width="24"
          height="24">
      </button>
    </div>

      <!-- Include Dropdown Menu -->
      {% render 'wiertla-categories-mobile-dropdown' %}
    </div>


  </div>
</div>

<!-- Mobile Rent Modal -->
<div class="wiertla-categories__mobile-rent-modal" style="display: none;">
  <div class="wiertla-categories__mobile-rent-wrapper">
    <!-- Rent header -->
    <div class="wiertla-categories__mobile-rent-header">
      <div class="wiertla-categories__mobile-rent-icon">
        <img
          src="{{ 'icon_calendar.svg' | asset_url }}"
          alt="Calendar"
          class="wiertla-categories__mobile-rent-icon-inner"
          width="24"
          height="24">
      </div>
      <div class="wiertla-categories__mobile-rent-title">WYPOŻYCZ WIERTŁO</div>
      <div class="wiertla-categories__mobile-rent-close-wrapper">
        <img
          src="{{ 'closee.svg' | asset_url }}"
          alt="Close"
          class="wiertla-categories__mobile-rent-close"
          width="24"
          height="24">
      </div>
    </div>

    <!-- Rent content -->
    <div class="wiertla-categories__mobile-rent-content">
      <p class="wiertla-categories__mobile-rent-description">
        Oferujemy naszym partnerom, możliwość wypożyczenia wybranego wiertła na wybrany termin i czas.
      </p>
      <p class="wiertla-categories__mobile-rent-contact">
        Skontaktuj się z nami, aby ustalić szczegóły<br>
        lub wyślij zapytanie o preferowany termin.
      </p>

      <!-- Contact info -->
      <div class="wiertla-categories__mobile-rent-contact-info">
        <div class="wiertla-categories__mobile-rent-phone">
          <img 
            src="{{ 'Ico_phone.svg' | asset_url }}" 
            alt="Phone"
            width="24"
            height="24">
          <a href="tel:+48600673736" class="wiertla-categories__mobile-rent-contact-link">+48 600 67 37 36</a>
        </div>
        <div class="wiertla-categories__mobile-rent-email">
          <img 
            src="{{ 'Ico_mail.svg' | asset_url }}" 
            alt="Email"
            width="24"
            height="24">
          <a href="mailto:biuro@hmmetal.pl" class="wiertla-categories__mobile-rent-contact-link">biuro@hmmetal.pl</a>
        </div>
      </div>

      <!-- Initial button -->
      <button class="wiertla-categories__mobile-rent-button" onclick="document.querySelector('.wiertla-categories__mobile-rent-form').style.display = 'flex'; this.style.display = 'none';">
        <span>Zapytaj o dostępny termin</span>
        <img src="{{ 'mail_icon_send.svg' | asset_url }}" alt="Send" width="24" height="24">
      </button>

      <!-- Form (hidden by default) -->
      <div class="wiertla-categories__mobile-rent-form" style="display: none;">
        <div class="wiertla-categories__mobile-rent-form-title">Skorzystaj z formularza</div>
        <form class="wiertla-categories__mobile-rent-form-content" onsubmit="return false;">
          <input type="hidden" name="form_type" value="contact">
          <input type="hidden" name="utf8" value="✓">
          <div class="wiertla-categories__mobile-rent-form-group">
            <input type="text" name="contact[contact_person]" placeholder="Osoba kontaktowa" required aria-required="true" aria-label="Osoba kontaktowa">
            <div class="wiertla-categories__mobile-rent-form-error" role="alert"></div>
          </div>
          <div class="wiertla-categories__mobile-rent-form-group">
            <input type="text" name="contact[company_name]" placeholder="Nazwa firmy" required aria-required="true" aria-label="Nazwa firmy">
            <div class="wiertla-categories__mobile-rent-form-error" role="alert"></div>
          </div>
          <div class="wiertla-categories__mobile-rent-form-row">
            <div class="wiertla-categories__mobile-rent-form-group">
              <input type="tel" name="contact[phone]" placeholder="Nr telefonu" required pattern="[0-9+\s\-()]{9,}" aria-required="true" aria-label="Numer telefonu" oninvalid="this.setCustomValidity('Proszę podać poprawny numer telefonu (minimum 9 znaków)')" oninput="this.setCustomValidity('')">
              <div class="wiertla-categories__mobile-rent-form-error" role="alert"></div>
            </div>
            <div class="wiertla-categories__mobile-rent-form-group">
              <input type="email" name="contact[email]" placeholder="E-mail" required aria-required="true" aria-label="Adres email" oninvalid="this.setCustomValidity('Proszę podać poprawny adres email')" oninput="this.setCustomValidity('')">
              <div class="wiertla-categories__mobile-rent-form-error" role="alert"></div>
            </div>
          </div>
          <div class="wiertla-categories__mobile-rent-form-group">
            <input type="text" name="contact[drill_symbol]" placeholder="SYMBOL wiertła" value="{{ product.symbol | default: '' }}" required aria-required="true" aria-label="Symbol wiertła">
            <div class="wiertla-categories__mobile-rent-form-error" role="alert"></div>
          </div>
          <div class="wiertla-categories__mobile-rent-form-group">
            <input type="date" name="contact[rental_date]" class="wiertla-categories__mobile-rent-date" placeholder="Wpisz preferowany termin wypożyczenia" required aria-required="true" aria-label="Preferowany termin wypożyczenia" min="{{ 'now' | date: '%Y-%m-%d' }}" value="{{ 'now' | date: '%Y-%m-%d' | date: '%Y-%m-%d' }}" onclick="this.showPicker()">
            <div class="wiertla-categories__mobile-rent-form-error" role="alert"></div>
          </div>
          <button type="submit" class="wiertla-categories__mobile-rent-submit" onclick="handleFormSubmit(event)">
            <span>Wyślij wiadomość</span>
            <img src="{{ 'mail_icon_send.svg' | asset_url }}" alt="Send" width="24" height="24">
          </button>
        </form>

        <!-- Success message (hidden by default) -->
        <div class="wiertla-categories__mobile-rent-success" style="display: none;">
          <div class="wiertla-categories__mobile-rent-success-content">
            <div class="wiertla-categories__mobile-rent-success-icon">
              <img src="{{ 'mail_sended.svg' | asset_url }}" alt="Mail sent" width="24" height="24">
            </div>
            <div class="wiertla-categories__mobile-rent-success-message">
              Dziękujemy za wysłanie zapytania
            </div>
          </div>
          <p class="wiertla-categories__mobile-rent-success-note">
            Czas na odpowiedź wynosi zwykle 24 godziny w dni robocze. Jeśli potrzebujesz wiertła szybciej, zadzwoń.
          </p>
          <button class="wiertla-categories__mobile-rent-button" style="display: flex; background-color: #FFFFFF; border: 2px solid #FFE500" onclick="window.closeRentModal()">
            <span>Wysłano wiadomość</span>
            <img src="{{ 'mail_sended.svg' | asset_url }}" alt="Send" width="24" height="24">
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Rent modal control functions
  window.openRentModal = function (product) {
    const modal = document.querySelector(".wiertla-categories__mobile-rent-modal");
    if (modal) {
      // Add active class first
      modal.classList.add("active");
      
      // Then set display to flex
      modal.style.display = "flex";
      
      // Update modal content if product is provided
      if (product) {
        const title = modal.querySelector('.wiertla-categories__mobile-rent-title');
        if (title) {
          title.textContent = product.title;
        }
      }
      
      // Prevent body scrolling
      document.body.style.setProperty('overflow', 'hidden');
    }
    return false;
  };

  window.closeRentModal = function () {
    const modal = document.querySelector(".wiertla-categories__mobile-rent-modal");
    if (modal) {
      // Remove active class first
      modal.classList.remove("active");
      
      // Then set display to none
      modal.style.display = "none";
      
      // Restore body scrolling
      document.body.style.setProperty('overflow', '');
    }
  };

  // Add event listeners when DOM is loaded
  document.addEventListener("DOMContentLoaded", function() {
    // Handle rent button click to show form
    const rentButton = document.querySelector(".wiertla-categories__mobile-rent-button");
    const rentForm = document.querySelector(".wiertla-categories__mobile-rent-form");
    
    if (rentButton && rentForm) {
      rentButton.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        rentForm.style.setProperty('display', 'flex');
        rentButton.style.setProperty('display', 'none');
      });
    }

    // Handle rent form submission
    const rentFormElement = document.querySelector(".wiertla-categories__mobile-rent-form-content");
    if (rentFormElement) {
      rentFormElement.addEventListener("submit", function(e) {
        e.preventDefault();
        // Add your form submission logic here
        window.closeRentModal();
      });
    }

    // Handle close button clicks
    const closeButtons = document.querySelectorAll(".wiertla-categories__mobile-rent-close, .wiertla-categories__mobile-rent-close-wrapper");
    closeButtons.forEach(function(btn) {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.closeRentModal();
      });
    });

    // Handle outside click
    const modal = document.querySelector(".wiertla-categories__mobile-rent-modal");
    const wrapper = document.querySelector(".wiertla-categories__mobile-rent-wrapper");
    if (modal && wrapper) {
      modal.addEventListener("click", function(e) {
        if (!wrapper.contains(e.target)) {
          window.closeRentModal();
        }
      });
    }
  });

  // Handle form submission
  function handleFormSubmit(event) {
    event.preventDefault();
    const form = event.target.closest('form');
    const successMessage = form.nextElementSibling;
    
    // Hide form and show success message
    form.style.display = 'none';
    successMessage.style.display = 'block';
  }
</script>

<!-- Mobile Product Preview Modal -->
<div class="wiertla-categories__mobile-preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;">
  <div class="wiertla-categories__mobile-preview-wrapper">
    <!-- Preview header -->
    <div class="wiertla-categories__mobile-preview-header">
      <div class="wiertla-categories__mobile-preview-icon">
        <img
          src="{{ 'loop_icon.svg' | asset_url }}"
          alt="Preview"
          class="wiertla-categories__mobile-preview-icon-inner"
          width="24"
          height="24">
      </div>
      <div class="wiertla-categories__mobile-preview-title">Podgląd</div>
      <div class="wiertla-categories__mobile-preview-close-wrapper" onclick="closePreviewModal()">
        <img
          src="{{ 'closee.svg' | asset_url }}"
          alt="Close"
          class="wiertla-categories__mobile-preview-close"
          width="24"
          height="24">
      </div>
    </div>
    
    <!-- Product Card Preview (exact same structure as mobile card) -->
    <div class="wiertla-categories__mobile-preview-card">
      <div class="wiertla-categories__mobile-top">
        <div class="wiertla-categories__mobile-image">
          <img src="" alt="Product" width="34" height="34" loading="lazy" class="wiertla-categories__mobile-preview-product-image">
        </div>
        <div class="wiertla-categories__mobile-fi">
          <span class="mobile-value wiertla-categories__mobile-preview-fi-value">-</span>
        </div>
        <div class="wiertla-categories__mobile-dimension wiertla-categories__mobile-preview-dimension-value">
          -
        </div>
        <div class="wiertla-categories__mobile-price-wrapper">
          <div class="wiertla-categories__mobile-price wiertla-categories__mobile-preview-price-value">
            -
          </div>
        </div>
      </div>
      <div class="wiertla-categories__mobile-bottom">
        <div class="wiertla-categories__mobile-vendor wiertla-categories__mobile-preview-vendor-value">
          -
        </div>
        <div class="wiertla-categories__mobile-symbol wiertla-categories__mobile-preview-symbol-value">
          -
        </div>
       
      </div>
    </div>

    <!-- Details Button -->
    <div class="wiertla-categories__mobile-preview-button-container">
      <a href="#" class="wiertla-categories__mobile-preview-button">
        <span>Zobacz szczegóły</span>
        <img
          src="{{ 'Arrow_forward_ios_24dp_5F6368_FILL0_wght400_GRAD0_opsz.svg' | asset_url }}"
          alt="Arrow"
          class="wiertla-categories__mobile-preview-button-icon"
          width="24"
          height="24">
      </a>
    </div>
  </div>
</div>

<script>
  // Close preview modal function
  window.closePreviewModal = function() {
    const modal = document.querySelector(".wiertla-categories__mobile-preview-modal");
    if (modal) {
      modal.style.display = "none";
      modal.classList.remove("active");
      document.body.style.overflow = "";
    }
  };

  // Update mobile preview modal with product data
  window.updateMobilePreview = function(product) {
    console.log("updateMobilePreview called with:", product); // Debug log
    
    const modal = document.querySelector(".wiertla-categories__mobile-preview-modal");
    if (!modal) {
      console.error("Modal not found!");
      return;
    }

    // Get all elements
    const productImage = modal.querySelector(".wiertla-categories__mobile-preview-product-image");
    const largeProductImage = modal.querySelector(".wiertla-categories__mobile-preview-large-image");
    const fiValue = modal.querySelector(".wiertla-categories__mobile-preview-fi-value");
    const dimensionValue = modal.querySelector(".wiertla-categories__mobile-preview-dimension-value");
    const vendorValue = modal.querySelector(".wiertla-categories__mobile-preview-vendor-value");
    const symbolValue = modal.querySelector(".wiertla-categories__mobile-preview-symbol-value");
    const priceValue = modal.querySelector(".wiertla-categories__mobile-preview-price-value");
    const detailsButton = modal.querySelector(".wiertla-categories__mobile-preview-button");

    console.log("Modal elements found:", {
      productImage: !!productImage,
      largeProductImage: !!largeProductImage,
      fiValue: !!fiValue,
      dimensionValue: !!dimensionValue,
      vendorValue: !!vendorValue,
      symbolValue: !!symbolValue,
      priceValue: !!priceValue,
      detailsButton: !!detailsButton
    });

    // Set product images
    if (productImage) {
      if (product.image && product.image.trim() !== '') {
        productImage.src = product.image;
        productImage.style.display = "block";
      } else {
        // Use a default placeholder
        productImage.src = "{{ 'image-8.png' | asset_url }}";
        productImage.style.display = "block";
      }
    }

    // Set large product image (use the same logic as desktop preview system)
    if (largeProductImage) {
      console.log("Product data for large image:", {
        featured_image: product.featured_image,
        large_image: product.large_image,
        image: product.image
      });
      
      // Use same fallback logic as desktop preview: image || large_image || featured_image
      const imageUrl = product.image || product.large_image || product.featured_image || "{{ 'custom_icons.png' | asset_url }}";
      console.log("Using image URL:", imageUrl);
      
      largeProductImage.src = imageUrl;
      largeProductImage.style.display = "block";
    }

    // Set all the product data
    if (fiValue) fiValue.textContent = product.fi || '-';
    if (dimensionValue) dimensionValue.textContent = product.dimension || '-';
    if (vendorValue) vendorValue.textContent = product.vendor || '-';
    if (symbolValue) symbolValue.textContent = product.symbol || '-';
    if (priceValue) priceValue.textContent = product.price || '-';

    // Set details button link
    if (detailsButton) {
      if (product.url && product.url.trim() !== '') {
        detailsButton.href = product.url;
        detailsButton.onclick = null;
      } else {
        // If no URL, try to construct one from product ID
        const productId = product.id;
        if (productId) {
          detailsButton.href = `/products/${productId}`;
          detailsButton.onclick = null;
        } else {
          detailsButton.href = "#";
          detailsButton.onclick = function(e) { e.preventDefault(); };
        }
      }
    }

    console.log("Data set in modal"); // Debug log

    // Show modal with proper flex display for overlay
    modal.style.display = "flex";
    modal.classList.add("active");
    document.body.style.overflow = "hidden";
  };

  // Test function to manually trigger modal (for debugging)
  window.testMobilePreview = function() {
    console.log("Testing mobile preview modal...");
    const testProduct = {
      image: "{{ 'image-8.png' | asset_url }}",
      featured_image: "{{ 'image-8.png' | asset_url }}", // Main product image
      fi: "⌀ 12",
      dimension: "100mm",
      vendor: "Test Vendor", 
      symbol: "TEST123",
      price: "149.99 zł",
      url: "#"
    };
    window.updateMobilePreview(testProduct);
  };

  // Add event listeners when DOM is ready
  document.addEventListener("DOMContentLoaded", function() {
    console.log("=== MOBILE COMPONENTS LOADED ===");
    console.log("Modal found:", !!document.querySelector(".wiertla-categories__mobile-preview-modal"));
    console.log("Test function available:", !!window.testMobilePreview);
    
    // Handle close button clicks
    const closeButton = document.querySelector(".wiertla-categories__mobile-preview-close-wrapper");
    if (closeButton) {
      closeButton.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.closePreviewModal();
      });
    }

    // Handle outside click to close modal
    const modal = document.querySelector(".wiertla-categories__mobile-preview-modal");
    if (modal) {
      modal.addEventListener("click", function(e) {
        if (e.target === modal) {
          window.closePreviewModal();
        }
      });
    }
  });
</script>

<!-- Load the mobile filter modal JavaScript -->
<script src="{{ 'wiertla-filter-modal.js' | asset_url }}" defer></script>