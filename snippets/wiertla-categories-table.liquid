{% comment %}
  Wiertla Categories Table Component
  A reusable component to display the product table for the Wiertla CNC Shopify theme.
{% endcomment %}

<style>
  @media (min-width: 769px) {
    .wiertla-categories__table-container {
      max-height: 800px; /* Approximate height for 20 items */
      overflow-y: auto;
      scrollbar-width: thin;
    }
    
    /* Styling for WebKit browsers (Chrome, Safari) */
    .wiertla-categories__table-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .wiertla-categories__table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    .wiertla-categories__table-container::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    .wiertla-categories__table-container::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  }
  
  /* Hide/show table columns based on tab type */
  .wiertla-categories__table-header-wiertla,
  .wiertla-categories__table-header-plytki,
  .wiertla-categories__table-header-koronki {
    display: none;
  }
  
  /* Show appropriate header based on active tab */
  .tab-active-wiertla .wiertla-categories__table-header-wiertla {
    display: table-row;
  }
  
  .tab-active-plytki .wiertla-categories__table-header-plytki {
    display: table-row;
  }
  
  .tab-active-koronki .wiertla-categories__table-header-koronki {
    display: table-row;
  }
</style>

<div class="wiertla-categories__table-container">
  
  <!-- Mobile Table Header for Plytki/Koronki -->
  <div class="wiertla-categories__mobile-table-header wiertla-categories__mobile-header-plytki mobile" style="display: none;">
    <!-- First header row -->
    <div class="wiertla-categories__mobile-header-top">
      <div class="wiertla-categories__mobile-header-img">
        <img src="{{ 'first_th.png' | asset_url }}" alt="Header icon" width="34" height="34">
      </div>
      <div class="wiertla-categories__mobile-header-gniazdo">
        <div>Gniazdo</div>
      </div>
      <div class="wiertla-categories__mobile-header-rodzaj">
        <div>Rodzaj</div>
      </div>
      <div class="wiertla-categories__mobile-header-price">
        <div>Cena netto</div>
      </div>
    </div>
    
    <!-- Second header row -->
    <div class="wiertla-categories__mobile-header-bottom">
      <div class="wiertla-categories__mobile-header-vendor">
        <div>PRODUCENT</div>
      </div>
      <div class="wiertla-categories__mobile-header-kod">
        <div>KOD P/N</div>
      </div>
      <div class="wiertla-categories__mobile-header-ilosc">
        <div>ILOŚĆ</div>
      </div>
    </div>
  </div>

  <table class="wiertla-categories__table">
    <thead>
      <!-- Wiertla table header -->
      <tr class="wiertla-categories__table-header-wiertla">
        <th>Typ</th>
        <th>⌀ Fi</th>
        <th>D/mm</th>
        <th>Symbol</th>
        <th>Producent</th>
        <th>Cena netto</th>
      </tr>
      
      <!-- Plytki table header -->
      <tr class="wiertla-categories__table-header-plytki">
        <th>Gniazdo</th>
        <th>Producent</th>
        <th>Kod producenta</th>
        <th>Rodzaj</th>
        <th>Ilość</th>
        <th>Cena netto</th>
      </tr>
      
      <!-- Koronki table header -->
      <tr class="wiertla-categories__table-header-koronki">
        <th>Gniazdo</th>
        <th>Producent</th>
        <th>Kod producenta</th>
        <th>Rodzaj</th>
        <th>Ilość</th>
        <th>Cena netto</th>
      </tr>
    </thead>
    <tbody id="productsTableBody">
      <!-- Products will be inserted here by JavaScript -->
    </tbody>
  </table>
</div>

<!-- Results Count and Pagination -->
<div class="wiertla-categories__results">
  <div class="wiertla-categories__results-wrapper">
    <div class="wiertla-categories__results-count">
      <span class="wiertla-categories__results-text desktop">Wyświetlono wyniki </span>
      <span class="wiertla-categories__results-text mobile">Wyświetlono</span>
      <span class="wiertla-categories__results-numbers" id="resultsCount"></span>
    </div>
    <div class="wiertla-categories__simple-pagination">
      <button class="wiertla-categories__pagination-button" id="prevPage" disabled>
        <span class="desktop">pokaż poprzednie</span>
        <span class="mobile">poprzednie</span>
      </button>
      <button class="wiertla-categories__pagination-button" id="nextPage">
        <span class="desktop">pokaż następne</span>
        <span class="mobile">następne</span>
      </button>
    </div>
  </div>
</div>

<script>
  // Function to update table headers based on active tab (applies to all instances)
  function updateTableHeaders(tabType) {
    const isTabletMobile = window.innerWidth <= 1024;
    // For each table container present (normal and fullscreen clones)
    document.querySelectorAll('.wiertla-categories__table-container').forEach(function(container) {
      // Toggle tab-active class on this container
      container.classList.remove('tab-active-wiertla', 'tab-active-plytki', 'tab-active-koronki');
      container.classList.add(`tab-active-${tabType}`);

      // Hide mobile header blocks within this container
      container.querySelectorAll('.wiertla-categories__mobile-table-header').forEach(function(header) {
        header.style.display = 'none';
      });

      // Control visibility of thead rows within this container only
      const headW = container.querySelector('.wiertla-categories__table-header-wiertla');
      const headP = container.querySelector('.wiertla-categories__table-header-plytki');
      const headK = container.querySelector('.wiertla-categories__table-header-koronki');
      if (headW) headW.style.display = 'none';
      if (headP) headP.style.display = 'none';
      if (headK) headK.style.display = 'none';

      if (!isTabletMobile) {
        if (tabType === 'wiertla' && headW) headW.style.display = 'table-row';
        if (tabType === 'plytki' && headP) headP.style.display = 'table-row';
        if (tabType === 'koronki' && headK) headK.style.display = 'table-row';
      } else {
        const plytkiHeader = container.querySelector('.wiertla-categories__mobile-header-plytki');
        if (plytkiHeader) plytkiHeader.style.display = 'block';
      }
    });
  }
  
  // Listen for tab changes
  (function initWiertlaCategoriesTable() {
    function bind() {
      // Set initial state
      const params = new URLSearchParams(window.location.search);
      let tabType = params.get('mainType');
      if (!tabType) {
        const activeTab = document.querySelector('.wiertla-categories__tab.active');
        tabType = activeTab ? activeTab.getAttribute('data-tab-type') : null;
      }
      if (!tabType) tabType = 'wiertla';
      updateTableHeaders(tabType);

      // Re-evaluate on resize to keep headers consistent
      window.addEventListener('resize', function() {
        const active = document.querySelector('.wiertla-categories__tab.active');
        const t = active ? active.getAttribute('data-tab-type') : 'wiertla';
        updateTableHeaders(t);
      });

      // Add event listeners to all tabs
      document.querySelectorAll('.wiertla-categories__tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          const tt = this.getAttribute('data-tab-type');
          updateTableHeaders(tt);
        });
      });

      // Make rows clickable via delegation
      const tableBody = document.getElementById('productsTableBody');
      if (tableBody && !tableBody.dataset.clickBound) {
        tableBody.addEventListener('click', function(e) {
          if (e.target.closest('.wiertla-categories__rent-button')) return;
          const hrefEl = e.target.closest('[data-href]');
          let url = hrefEl ? hrefEl.getAttribute('data-href') : '';
          if (!url) {
            const tr = e.target.closest('tr[data-href]');
            if (tr) url = tr.getAttribute('data-href');
          }
          if (url) {
            if (e.metaKey || e.ctrlKey) {
              window.open(url, '_blank');
            } else {
              window.location.href = url;
            }
          }
        });
        tableBody.dataset.clickBound = 'true';
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bind);
    } else {
      bind();
    }
    document.addEventListener('shopify:section:load', bind);
  })();
  
  // Make function available globally for debugging
  window.testTableHeaders = function(tabType) {
    updateTableHeaders(tabType);
  };
</script>
