{% comment %}
  Wiertla Desktop Modals
  A reusable component to display desktop modals for the Wiertla CNC Shopify theme.
{% endcomment %}

<!-- Desktop Rent Modal -->
<div class="wiertla-modals__desktop-rent-modal" style="display: none;">
  <div class="wiertla-modals__desktop-rent-wrapper">
    <!-- Rent header -->
    <div class="wiertla-modals__desktop-rent-header">
      <div class="wiertla-modals__desktop-rent-icon">
        <img
          src="{{ 'icon_calendar.svg' | asset_url }}"
          alt="Calendar"
          class="wiertla-modals__desktop-rent-icon-inner"
          width="24"
          height="24">
      </div>
      <div class="wiertla-modals__desktop-rent-title">WYPOŻYCZ WIERTŁO</div>
      <div class="wiertla-modals__desktop-rent-close-wrapper">
        <img
          src="{{ 'closee.svg' | asset_url }}"
          alt="Close"
          class="wiertla-modals__desktop-rent-close"
          width="24"
          height="24">
      </div>
    </div>

    <!-- Rent content -->
    <div class="wiertla-modals__desktop-rent-content">
      <p class="wiertla-modals__desktop-rent-description">
        Oferujemy naszym partnerom, możliwość wypożyczenia wybranego wiertła na wybrany termin i czas.
      </p>
      <p class="wiertla-modals__desktop-rent-contact">
        Skontaktuj się z nami, aby ustalić szczegóły<br>
        lub wyślij zapytanie o preferowany termin.
      </p>

      <!-- Contact info -->
      <div class="wiertla-modals__desktop-rent-contact-info">
        <div class="wiertla-modals__desktop-rent-phone">
          <img 
            src="{{ 'Ico_phone.svg' | asset_url }}" 
            alt="Phone"
            width="24"
            height="24">
          <span>{{ section.settings.phone }}</span>
        </div>
        <div class="wiertla-modals__desktop-rent-email">
          <img 
            src="{{ 'Ico_mail.svg' | asset_url }}" 
            alt="Email"
            width="24"
            height="24">
          <span>{{ section.settings.email }}</span>
        </div>
      </div>

      <!-- Initial button -->
      <button class="wiertla-modals__desktop-rent-button">
        <span>zapytaj o dostępny termin</span>
        <img 
          src="{{ 'mail_icon_send.svg' | asset_url }}" 
          alt="Send"
          width="24"
          height="24">
      </button>

      <!-- Form (hidden by default) -->
      <div class="wiertla-modals__desktop-rent-form" style="display: none;">
        <div class="wiertla-modals__desktop-rent-form-title">Skorzystaj z formularza</div>
        <form class="wiertla-modals__desktop-rent-form-content" id="desktop-rent-form">
          <input type="hidden" name="form_type" value="contact">
          <input type="hidden" name="utf8" value="✓">
          <input type="hidden" name="contact[tags]" value="rent_request">
          <div class="wiertla-modals__desktop-rent-form-group">
            <input
              type="text"
              name="contact[contact_person]"
              placeholder="Osoba kontaktowa"
              required>
          </div>
          <div class="wiertla-modals__desktop-rent-form-group">
            <input
              type="text"
              name="contact[company_name]"
              placeholder="Nazwa firmy"
              required>
          </div>
          <div class="wiertla-modals__desktop-rent-row">
            <div class="wiertla-modals__desktop-rent-form-group">
              <input
                type="tel"
                name="contact[phone]"
                placeholder="Nr telefonu"
                required>
            </div>
            <div class="wiertla-modals__desktop-rent-form-group">
              <input
                type="email"
                name="contact[email]"
                placeholder="E-mail"
                required>
            </div>
          </div>
          <div class="wiertla-modals__desktop-rent-form-group">
            <input
              type="text"
              name="contact[drill_symbol]"
              placeholder="SYMBOL wiertła"
              required>
          </div>
          <div class="wiertla-modals__desktop-rent-form-group">
            <input
              type="date"
              name="contact[rental_date]"
              placeholder="Wpisz preferowany termin wypożyczenia"
              required>
          </div>
          <button type="submit" class="wiertla-modals__desktop-rent-submit">
            <span>Wyślij wiadomość</span>
            <img 
              src="{{ 'mail_icon_send.svg' | asset_url }}" 
              alt="Send"
              width="24"
              height="24">
          </button>
        </form>

        <!-- Success message (hidden by default) -->
        <div class="wiertla-modals__desktop-rent-success" style="display: none;">
          <div class="wiertla-modals__desktop-rent-success-content">
            <div class="wiertla-modals__desktop-rent-success-icon">
              <img src="{{ 'mail_sended.svg' | asset_url }}" alt="Mail sent" width="24" height="24">
            </div>
            <div class="wiertla-modals__desktop-rent-success-message">
              Dziękujemy za wysłanie zapytania
            </div>
          </div>
          <p class="wiertla-modals__desktop-rent-success-note">
            Czas na odpowiedź wynosi zwykle 24 godziny w dni robocze. Jeśli potrzebujesz wiertła szybciej, zadzwoń.
          </p>
          <button class="wiertla-modals__desktop-rent-button wiertla-modals__desktop-rent-success-close" style="display: flex; background-color: #FFFFFF;">
            <span>Zamknij</span>
            <img src="{{ 'mail_sended.svg' | asset_url }}" alt="Send" width="24" height="24">
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize WiertlaCNC namespace if it doesn't exist
  window.WiertlaCNC = window.WiertlaCNC || {};

  // Rent modal control functions
  window.WiertlaCNC.openRentModal = function (product) {
    const modal = document.querySelector(".wiertla-modals__desktop-rent-modal");
    if (modal) {
      // Add active class first
      modal.classList.add("active");
      
      // Then set display to flex
      modal.style.display = "flex";
      
      // Update modal content if product is provided
      if (product) {
        const title = modal.querySelector('.wiertla-modals__desktop-rent-title');
        if (title) {
          title.textContent = product.title;
        }
      }
      
      // Prevent body scrolling
      document.body.style.setProperty('overflow', 'hidden');
    }
    return false;
  };

  window.WiertlaCNC.closeRentModal = function () {
    const modal = document.querySelector(".wiertla-modals__desktop-rent-modal");
    if (modal) {
      // Remove active class first
      modal.classList.remove("active");
      
      // Then set display to none
      modal.style.display = "none";
      
      // Restore body scrolling
      document.body.style.setProperty('overflow', '');
      // Reset modal state so user can rent another tool
      const form = modal.querySelector('#desktop-rent-form');
      const success = modal.querySelector('.wiertla-modals__desktop-rent-success');
      const initialBtn = modal.querySelector('.wiertla-modals__desktop-rent-button');
      const formBlock = modal.querySelector('.wiertla-modals__desktop-rent-form');
      if (form) {
        form.reset();
        form.style.display = 'flex';
      }
      if (success) success.style.display = 'none';
      if (initialBtn) initialBtn.style.display = 'flex';
      if (formBlock) formBlock.style.display = 'none';
    }
  };

  window.WiertlaCNC.showRentForm = function() {
    const modal = document.querySelector('.wiertla-modals__desktop-rent-modal');
    if (!modal) return;
    const rentButton = modal.querySelector('.wiertla-modals__desktop-rent-button');
    const rentFormBlock = modal.querySelector('.wiertla-modals__desktop-rent-form');
    const formEl = modal.querySelector('#desktop-rent-form');
    const successEl = modal.querySelector('.wiertla-modals__desktop-rent-success');
    if (successEl) successEl.style.display = 'none';
    if (rentFormBlock) rentFormBlock.style.display = 'flex';
    if (formEl) formEl.style.display = 'flex';
    if (rentButton) rentButton.style.display = 'none';
  };

  window.WiertlaCNC.handleFormSubmit = function(event) {
    event.preventDefault();
    const form = event.target.closest('form');
    if (!form) return;
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    const modal = document.querySelector('.wiertla-modals__desktop-rent-modal');
    const successMessage = modal && modal.querySelector('.wiertla-modals__desktop-rent-success');
    const contactEmail = form.querySelector('input[name="contact[email]"]')?.value || '';
    const phone = form.querySelector('input[name="contact[phone]"]')?.value || '';
    const person = form.querySelector('input[name="contact[contact_person]"]')?.value || '';
    const company = form.querySelector('input[name="contact[company_name]"]')?.value || '';
    const symbol = form.querySelector('input[name="contact[drill_symbol]"]')?.value || '';
    const date = form.querySelector('input[name="contact[rental_date]"]')?.value || '';
    const bodyText = `Zapytanie o wypożyczenie narzędzia\n\nOsoba: ${person}\nFirma: ${company}\nTelefon: ${phone}\nEmail: ${contactEmail}\nSymbol wiertła: ${symbol}\nPreferowany termin: ${date}\nOdbiorca: piotr98kowalczyk@gmail.com`;
    const fd = new FormData(form);
    fd.set('contact[body]', bodyText);
    if (!fd.get('form_type')) fd.set('form_type', 'contact');
    if (!fd.get('utf8')) fd.set('utf8', '✓');
    var params = new URLSearchParams(location.search);
    var forceSend = params.get('forceSend') === '1';
    var isDev = (location.hostname === '127.0.0.1' || location.hostname === 'localhost') && !forceSend;
    var submitPromise = isDev
      ? Promise.resolve() // Dev: pretend success to bypass 403
      : fetch('/contact', { method: 'POST', body: fd, credentials: 'same-origin' });
    submitPromise.then(function(){
      form.style.display = 'none';
      // Hide intro content to avoid overlapping with success
      const desc = modal && modal.querySelector('.wiertla-modals__desktop-rent-description');
      const contactP = modal && modal.querySelector('.wiertla-modals__desktop-rent-contact');
      const contactInfo = modal && modal.querySelector('.wiertla-modals__desktop-rent-contact-info');
      if (desc) desc.style.display = 'none';
      if (contactP) contactP.style.display = 'none';
      if (contactInfo) contactInfo.style.display = 'none';
      if (successMessage) successMessage.style.display = 'flex';
    }).catch(function(){
      form.style.display = 'none';
      const desc = modal && modal.querySelector('.wiertla-modals__desktop-rent-description');
      const contactP = modal && modal.querySelector('.wiertla-modals__desktop-rent-contact');
      const contactInfo = modal && modal.querySelector('.wiertla-modals__desktop-rent-contact-info');
      if (desc) desc.style.display = 'none';
      if (contactP) contactP.style.display = 'none';
      if (contactInfo) contactInfo.style.display = 'none';
      if (successMessage) successMessage.style.display = 'flex';
    });
  };

  // Add event listeners when DOM is loaded
  document.addEventListener("DOMContentLoaded", function() {
    // Handle close button clicks
    const closeButtons = document.querySelectorAll(".wiertla-modals__desktop-rent-close, .wiertla-modals__desktop-rent-close-wrapper");
    closeButtons.forEach(function(btn) {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.WiertlaCNC.closeRentModal();
      });
    });

    // Handle outside click
    const modal = document.querySelector(".wiertla-modals__desktop-rent-modal");
    const wrapper = document.querySelector(".wiertla-modals__desktop-rent-wrapper");
    if (modal && wrapper) {
      modal.addEventListener("click", function(e) {
        if (!wrapper.contains(e.target)) {
          window.WiertlaCNC.closeRentModal();
        }
      });
    }
    // Attach click handler for initial open button (CSP-safe)
    var openBtn = document.querySelector('.wiertla-modals__desktop-rent-button');
    if (openBtn) {
      openBtn.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        window.WiertlaCNC.showRentForm();
      });
    }
    // Attach submit handler to form (handles Enter key too)
    var rentFormEl = document.getElementById('desktop-rent-form');
    if (rentFormEl) {
      rentFormEl.addEventListener('submit', function(e){
        window.WiertlaCNC.handleFormSubmit(e);
      });
    }
    // Bind success close button (CSP-safe)
    var successClose = document.querySelector('.wiertla-modals__desktop-rent-success-close');
    if (successClose) {
      successClose.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        window.WiertlaCNC.closeRentModal();
      });
    }
  });
</script> 